{"version":3,"sources":["../../src/swc/compile.ts"],"sourcesContent":["import slash from 'slash';\nimport { promises } from \"fs\";\nimport { dirname, relative } from \"path\";\nimport { transformFile, transformFileSync } from \"@swc/core\";\nimport type { Options, Output } from \"@swc/core\";\n\nconst {\n  mkdir,\n  stat,\n  writeFile\n} = promises;\n\nfunction withSourceMap(output: Output, options: Options, destFile: string, destDir: string) {\n  if (!output.map || options.sourceMaps === \"inline\") {\n    return {\n      sourceCode: output.code,\n    }\n  }\n  // TODO: remove once fixed in core https://github.com/swc-project/swc/issues/1388\n  const sourceMap = JSON.parse(output.map);\n  if (options.sourceFileName) {\n    sourceMap['sources'][0] = options.sourceFileName;\n  }\n  if (options.sourceRoot) {\n    sourceMap['sourceRoot'] = options.sourceRoot;\n  }\n  output.map = JSON.stringify(sourceMap);\n\n  const sourceMapPath = destFile + \".map\";\n  output.code += `\\n//# sourceMappingURL=${slash(relative(destDir, sourceMapPath))}`;\n\n  return {\n    sourceMap: output.map,\n    sourceMapPath,\n    sourceCode: output.code\n  }\n}\n\nexport async function outputResult(\n  output: Output,\n  sourceFile: string,\n  destFile: string,\n  options: Options\n) {\n  const destDir = dirname(destFile);\n\n  const {\n    sourceMap,\n    sourceMapPath,\n    sourceCode\n  } = withSourceMap(output, options, destFile, destDir);\n\n  await mkdir(destDir, { recursive: true });\n  const { mode } = await stat(sourceFile);\n\n  if (!sourceMapPath) {\n    await writeFile(destFile, sourceCode, { mode });\n  } else {\n    await Promise.all([\n      writeFile(destFile, sourceCode, { mode }),\n      writeFile(sourceMapPath, sourceMap, { mode })\n    ]);\n  }\n}\n\nexport async function compile(\n  filename: string,\n  opts: Options,\n  sync: boolean,\n  outputPath: string | undefined\n): Promise<Output | void> {\n  const options = { ...opts };\n  if (outputPath) {\n    options.outputPath = outputPath;\n  }\n\n  try {\n    const result = sync\n      ? transformFileSync(filename, options)\n      : await transformFile(filename, options);\n\n    return result;\n  } catch (err) {\n    if (!err.message.includes(\"ignored by .swcrc\")) {\n      throw err;\n    }\n  }\n}\n"],"names":["outputResult","compile","mkdir","stat","writeFile","withSourceMap","output","options","destFile","destDir","map","sourceMaps","sourceCode","code","sourceMap","JSON","parse","sourceFileName","sourceRoot","stringify","sourceMapPath","sourceFile","recursive","mode","Promise","all","filename","opts","sync","outputPath","result","err","message","includes"],"mappings":"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"}